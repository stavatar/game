---
title: "FUTURE_STATE.md"
subtitle: "Планируемое будущее состояние системы"
author: "Проект 'Живой Мир - Симуляция Общества'"
date: "2026-02-02"
version: "1.0"
keywords:
  - будущее состояние
  - улучшения
  - архитектура
  - Task 002
  - EPIC
  - 197 проблем
language: "ru"
---

# Планируемое будущее состояние (FUTURE_STATE)

## Обзор

Документ описывает **планируемое будущее состояние** системы на основе исследования "World Simulation Realism Investigation" (Task 002), которое выявило **197 различных проблем** в текущей реализации, организованных в **6 основных EPIC** с четкой архитектурной иерархией.

**Ключевой вывод Task 002:** Система содержит ~2,600 строк хорошо написанного кода (40% всех AI/simulation систем), который **НИКОГДА НЕ ВЫЗЫВАЕТСЯ** из основного цикла симуляции. Значительная часть работы по улучшению включает подключение уже реализованных систем, а не написание нового кода.

---

## Выполнительное резюме

### Текущее состояние: Немассштабируемая система

Текущее состояние системы имеет критические архитектурные проблемы:

| Компонент | Статус | Проблема |
|-----------|--------|---------|
| Economic Base (Экономическая база) | Dead Code | `Production.produce()` никогда не вызывается |
| Property System (Система собственности) | Dead Code | Переходы собственности не срабатывают |
| Class System (Система классов) | Частично | Классы не учитывают экономику |
| AI Systems (AI Системы) | Неиспользуется | 1,586 строк кода, которые не вызываются |
| EventBus (Система событий) | Фасад | 0 подписчиков, 0 публикаций |
| Population (Население) | Collapse | ~12 NPC коллапсируют до 1-2 за 20 лет |

### Будущее состояние: Функционирующая марксистская симуляция

После завершения всех 197 улучшений система станет:

- **Функциональной марксистской симуляцией** с реальной цепочкой причинности: база → надстройка
- **Динамической экономикой** с трудовой теорией стоимости, первоначальным накоплением, технологическим развитием
- **Эмергентной классовой системой** с классовым сознанием, гегемонией, идеологической борьбой
- **Сложным AI** с BDI архитектурой, памятью, планированием, эмоциями
- **Стабильным населением** с демографикой, наследованием, социальным воспроизводством
- **Интегрированным миром** с климатом, ресурсами, пространственной динамикой

**Временная шкала:** 26 недель (примерно 6 месяцев) для полного внедрения

---

## Портфель EPIC: 6 основных категорий улучшений

### Иерархия зависимостей

```
                         ┌─────────────────────────────────────┐
                         │     TIER 0: КРИТИЧЕСКИЕ БЛОКЕРЫ     │
                         │  EPIC-INTEGRATION (19 проблем)       │
                         │  Недели: 1-4                         │
                         └─────────────────┬───────────────────┘
                                           │
                    ┌──────────────────────┼────────────────────┐
                    │                      │                    │
                    ▼                      ▼                    ▼
    ┌─────────────────────────┐  ┌──────────────────┐  ┌──────────────┐
    │  TIER 1: ЭКОНОМИЧЕСКАЯ  │  │  TIER 3: СОЦИАЛ  │  │  TIER 5: AI  │
    │  БАЗА (FOUNDATION)      │  │  (ПАРАЛЛЕЛЬНО)   │  │  (ПОСЛЕДНИЙ) │
    │ EPIC-ECONOMY (39)       │  │ EPIC-SOCIAL (36) │  │ EPIC-AI (36) │
    │ Недели: 5-10            │  │ Недели: 5-15     │  │ Недели: 21-26│
    └──────────┬──────────────┘  └──────────────────┘  └──────────────┘
               │
               ▼
    ┌─────────────────────────────────────────────┐
    │  TIER 2: НАДСТРОЙКА (SUPERSTRUCTURE)        │
    │  EPIC-SUPERSTRUCTURE (27 проблем)           │
    │  Недели: 11-16                              │
    └─────────────────┬───────────────────────────┘
                      │
                      ▼
    ┌─────────────────────────────────────────────┐
    │  TIER 4: МИР И ОКРУЖЕНИЕ (WORLD)            │
    │  EPIC-WORLD (42 проблемы)                   │
    │  Недели: 17-20                              │
    └─────────────────────────────────────────────┘
```

---

## EPIC 1: ИНТЕГРАЦИЯ (INTEGRATION) - Tier 0

**Epic ID:** EPIC-INTEGRATION
**Приоритет:** Критический (Tier 0) - Архитектурные блокеры
**Проблем:** 19 критических
**Продолжительность:** Недели 1-4 (4 недели)
**Статус:** Ключевые блокеры для всех остальных улучшений

### Описание

Основной цикл симуляции представляет собой **совокупность изолированных систем**, которые не взаимодействуют друг с другом. Несмотря на наличие софистицированных реализаций для Production (1,200+ строк), Property (800+ строк), Classes (600+ строк) и AI (1,586 строк), эти системы **НИКОГДА НЕ ВЫЗЫВАЮТСЯ** основным циклом симуляции.

### Критические проблемы

| ID | Проблема | Влияние | Решение |
|----|----------|--------|--------|
| INT-001 | Economic Base никогда не обновляется | Нет динамики производства | Wire up `Production.produce()` |
| INT-002 | Property никогда не меняется | Приватная собственность не возникает | Wire up `claim_land()`, `transfer_property()` |
| INT-003 | Classes никогда не определяются | Нет классовой динамики | Wire up `determine_class()` |
| INT-020 | EventBus неиспользуемый фасад | Нет связи между системами | Создать 20+ подписчиков на события |
| INT-021 | Две несовместимые NPC модели | Все AI системы неиспользуемы | Унифицировать NPCState и NPC class |
| INT-018 | Цепочка Property→Class→Ideology мертва | Нет базис→надстройка | Проводить события через все системы |

### Архитектурные улучшения

#### До интеграции (текущее состояние)
```
Simulation.update() {
    if random() < 0.1:
        _decide_action()  // 22 строки hardcoded логики
}
// Production, Property, Classes, EventBus, AI - все мертвый код
```

#### После интеграции (будущее состояние)
```
Simulation.update() {
    # 1. Временная прогрессия
    time.advance()
    climate.update_season()

    # 2. БАЗА (Economic foundation)
    economy.produce()  # -> event: production_completed
    property.claim_land()  # -> event: property_claimed
    economy.calculate_snlt()  # Социально необходимое время труда

    # 3. NPC действия
    for npc in npcs:
        npc_ai.run_bdi_cycle()  # BDI deliberation + Memory
        npc_ai.plan_action()    # Планирование (HTN/GOAP)
        npc_ai.execute()        # Выполнение

    # 4. НАДСТРОЙКА (Superstructure)
    classes.update_membership()  # На основе собственности
    culture.propagate_beliefs()  # На основе классовых интересов
    norms.adapt_traditions()     # На основе верований

    # 5. Социальное воспроизводство
    demography.calculate_birth_death()
    families.process_inheritance()
    classes.update_consciousness()

    # 6. Пространственная динамика
    world.process_migrations()
    world.update_resource_depletion()
    world.check_settlement_emergence()

# Все события логируются и анализируются
event_bus.publish(event)  # -> 20+ подписчиков
```

### Главные улучшения по компонентам

**Simulation Core:**
- Реальный порядок обновления: TIME → ECONOMY (Base) → NPC → CULTURE (Superstructure) → DEMOGRAPHY
- EventBus с 20+ подписчиками вместо текущих 0
- Проверка консистентности состояния после каждого этапа
- Отслеживание эмергентных явлений в реальном времени

**NPC System Unification:**
- Единая NPC model используется везде (вместо NPCState + NPC class)
- Все AI системы получают доступ к состоянию NPC
- BDI, Memory, Utility AI работают во время симуляции (вместо мертвого кода)

**Event-Driven Architecture:**
- Death events → Inheritance + Class changes + Belief propagation
- Property events → Class membership changes
- Belief events → Tradition adaptation
- Production events → Value calculation + Wealth distribution

---

## EPIC 2: ЭКОНОМИЧЕСКАЯ БАЗА (ECONOMY) - Tier 1

**Epic ID:** EPIC-ECONOMY
**Приоритет:** Tier 1 (После блокеров)
**Проблем:** 39 проблем (высокие + средние)
**Продолжительность:** Недели 5-10 (6 недель)
**Зависит от:** INT-021 (NPC унификация), SOC-040/041 (выживание населения)

### Описание

Экономическая база в текущей реализации состоит из **мертвого кода и фундаментально неправильных дизайнов**:
- **Production:** выход как произвольные константы без связи с трудом
- **Property:** отсутствует механика первоначального накопления
- **Technology:** идеалистическая (случайное открытие) вместо материалистической (труд-основанной)

Все эти системы **НИКОГДА НЕ ВЫЗЫВАЮТСЯ** основным циклом.

### Критические проблемы (7 блокирующих)

| ID | Проблема | Marxist Концепция | Решение |
|----|----------|------------------|--------|
| ECON-001 | Нет трудовой теории стоимости | Value = socially necessary labor time | Отслеживать часы работы, вычислять SNLT |
| ECON-002 | Нет SNLT (socially necessary labor time) | SNLT = социальный средний труд | Вычислять среднее время для каждого товара |
| ECON-005 | Нет рынка труда | Workers sell labor-power as commodity | Реализовать wage determination mechanism |
| ECON-020 | Нет первоначального накопления | Historical dispossession of peasants | Реалистичные переходы общего→частного |
| ECON-021 | Неправдоподобные переходы собственности | Enclosure process takes time | Процесс с этапами, требует земельных ресурсов |
| ECON-040 | Случайное открытие технологий | Technology requires material surplus | Связать технология с уровнем производства |
| ECON-042 | Нет материальных предпосылок для техники | Surplus must precede tech advancement | Вычислять доступный surplus, ограничивать tech |

### Модули для улучшения

#### Модуль 1: Трудовая теория стоимости (M1)

**Текущее состояние:**
```python
# src/economy/production.py
output = ProductionMethod.base_output * farmer.skill
# Случайное значение, не связано с трудом
```

**Будущее состояние:**
```python
class ProductionAction:
    worker: NPC
    method: ProductionMethod
    duration_hours: float  # Сколько часов на это потратили

    @property
    def value(self) -> float:
        c = constant_capital(tools, materials)  # Средства производства
        v = variable_capital(duration_hours, wage_rate)  # Переменный капитал
        s = surplus_value(method.snlt, duration_hours, wage_rate)  # Прибавочная стоимость
        return c + v + s  # Полная стоимость

# Рабочие, требующие больше времени чем SNLT = неэффективные производители
# Их "лишний" труд не создает стоимость (вот почему нужна конкуренция)
```

**Архитектурные улучшения:**
- `ProductionAction` с отслеживанием часов труда
- Система SNLT (socially necessary labor time) для каждого метода
- Расчет с = constant capital, v = variable capital, s = surplus value
- Эксплуатация видна числами: rate_of_exploitation = s/v

#### Модуль 2: Собственность и накопление (M2)

**Текущее состояние:**
```python
# Собственность: просто boolean флаг
npc.owns_land = True  # или False
```

**Будущее состояние:**
```python
class PropertyRelation:
    owner: NPC
    land_patch: TileCoord
    area_hectares: float
    established_year: int
    transition_type: PropertyTransition  # COMMUNE→PRIVATE, PRIVATE→COLLECTIVE, etc

    # Процесс первоначального накопления:
    # 1. Земля: COMMUNAL OWNERSHIP (все могут пользоваться)
    # 2. Transition: ENCLOSURE (требует: authority, military, legal system)
    # 3. Result: PRIVATE PROPERTY (владелец исключает других)
    # 4. Consequence: Крестьяне становятся пролетариями (landless)

# История: как возникают классовые отношения через отчуждение средств производства
```

**Архитектурные улучшения:**
- Историческая динамика переходов собственности
- Первоначальное накопление как процесс, а не магия
- Классовое воспроизводство через наследование собственности
- Связь: собственность → класс → идеология

#### Модуль 3: Технологическое развитие (M3)

**Текущее состояние:**
```python
# Технология появляется случайно
if random() < discovery_probability:
    technology = random.choice(all_technologies)
```

**Будущее состояние:**
```python
class Technology:
    prerequisites: List[Technology]  # Нужно 4 предыдущих технологий
    labor_accumulated: float = 0  # Часы работы с более простыми инструментами
    min_surplus_for_discovery: float  # Нужно достаточно избытка

    def can_be_discovered(self, civilization) -> bool:
        all_prerequisites_known = all(p in civilization.techs for p in self.prerequisites)
        society_has_surplus = civilization.total_surplus > self.min_surplus_for_discovery
        enough_labor_accumulated = self.labor_accumulated > self.discovery_threshold
        return all_prerequisites_known and society_has_surplus and enough_labor_accumulated

# Технология развивается из практики: больше опыта с пашней → плуг → конный плуг
# Это требует: материальный base (surplus), исторический процесс (накопленный труд)
```

**Архитектурные улучшения:**
- Технология от практики, не от случая
- Иерархия предпосылок (нельзя пропустить этапы)
- Связь с экономическим base: нужно достаточно surplus
- Технология как исторический процесс, длящийся эпохи

### Главные улучшения по системам

**Production System:**
- Отслеживание человеко-часов для каждого действия производства
- Расчет SNLT (socially necessary labor time) за социальный средний
- Система: c (constant capital) + v (variable capital) + s (surplus value)
- Видимая эксплуатация: rate = m'/v = surplus/wages

**Property System:**
- Исторические процессы переходов (не просто boolean)
- Первоначальное накопление как механика: энкрозуры требуют власти + ресурсов
- Наследование как способ воспроизводства классовых отношений
- Прямая связь: собственность → класс (тип класса зависит от отношения к средствам)

**Technology System:**
- Материалистическая модель: технология от практики, не от интеллекта
- Матрица предпосылок: нельзя изобрести паровую машину без инструментов
- Связь с экономикой: нужен surplus для изобретения (за счет того, что кто-то не работает)
- Историческое развитие: железный век → средневековье → ренессанс (через технологию)

---

## EPIC 3: НАДСТРОЙКА (SUPERSTRUCTURE) - Tier 2

**Epic ID:** EPIC-SUPERSTRUCTURE
**Приоритет:** Tier 2 (После base)
**Проблем:** 27 проблем
**Продолжительность:** Недели 11-16 (6 недель)
**Зависит от:** EPIC-ECONOMY (базис должен работать сначала)

### Описание

Система класса и идеологии в текущей реализации **механистична и статична**. Классовая гегемония моделируется как чистое экономическое владение, без идеологического лидерства. Система верований имеет **мертвый код**: поля `benefits_class` и `opposes_class` существуют, но НИКОГДА не проверяются при распространении верований, позволяя абсурдам типа крестьян-пролетариев усваивающих верование "property_sacred" (священность собственности).

### Критические проблемы (8 блокирующих)

| ID | Проблема | Gramscian Концепция | Решение |
|----|----------|-------------------|--------|
| SOC-001 | Нет культурной гегемонии | Hegemony = ideological leadership through consent | Добавить `hegemonic_control` отслеживание |
| SOC-003 | Нет органических интеллектуалов | Organic intellectuals articulate class consciousness | Механика появления классовых лидеров |
| SOC-009 | Нет контр-гегемонии | Subaltern classes can build alternative worldviews | Механика egalitarian ideology emergence |
| CULT-001 | Линейное последовательное появление | Belief state space non-linear, contested | Вероятностная модель с конкурирующими верованиями |
| CULT-007 | Классовые фильтры не используются | `benefits_class`/`opposes_class` игнорируются | Использовать при распространении верований |
| CULT-009 | Нет институциональной пропаганды | ISAs (schools, churches, media) missing | Создать ideological state apparatuses |
| CULT-013 | Нет контр-гегемонического появления | EQUALITY belief has no emergence path | Добавить механику восстания consciousness |
| CULT-003 | Только 5/10 типов верований имеют появление | Belief types incomplete | Полная система появления для всех верований |

### Модули для улучшения

#### Модуль 1: Система гегемонии (M1)

**Текущее состояние:**
```python
# Класс может доминировать только через экономическое владение
class SocialClass:
    members: Set[NPC]
    economic_power: float  # Владение средствами производства
    # Всё. Никаких других форм власти.
```

**Будущее состояние:**
```python
class SocialClass:
    members: Set[NPC]

    # Три типа власти:
    economic_power: float  # Владение средствами (прямая)
    political_power: float  # Контроль над государством (репрессия)
    hegemonic_control: float  # Идеологическое лидерство (согласие)

    # Стабильность доминации требует обоих:
    def domination_stability(self) -> float:
        # Согласие (через идеологию): 70% веса
        # Принуждение (через репрессию): 30% веса
        return (self.consent_level * 0.7 + self.coercion_capacity * 0.3)

    # Когда consent низко, нужно увеличивать coercion
    # Когда оба низки = революционная ситуация

# Гегемонию нельзя просто "иметь" - её нужно постоянно завоевывать через ISAs
```

**Архитектурные улучшения:**
- `hegemonic_control` метрика для каждого класса
- Отслеживание `consent_level` (принятие доминации)
- Отслеживание `coercion_capacity` (силовой аппарат)
- Формула стабильности: consent×0.7 + coercion×0.3
- Мониторинг революционных ситуаций: low consent + low coercion

#### Модуль 2: Органические интеллектуалы (M2)

**Текущее состояние:**
```python
# Нет механики появления лидеров класса
class_consciousness = random()  # Просто случайно
```

**Будущее состояние:**
```python
class OrganicIntellectual:
    origin_class: SocialClass  # Из какого класса вышел
    articulated_ideology: Belief  # Какую идеологию артикулирует
    reach: float  # Как много людей может влиять
    legitimacy: float  # Насколько люди его принимают

    # Условия появления:
    # 1. Надо быть из конкретного класса (пролетарий выражает пролетарское)
    # 2. Надо кристаллизироваться из классовых противоречий
    # 3. Надо набрать последователей через социальные сети

    def influence_peer(self, target_npc: NPC):
        # Вероятность убедить других зависит от:
        # - legitimacy (его кредибилити)
        # - target's class interest (интересует ли целевого их класс)
        # - relationship strength (близость)
        pass

# Органические интеллектуалы - основной способ распространения
# идеологии Это не центральное вещание, а боковое влияние
```

**Архитектурные улучшения:**
- Механика появления органических интеллектуалов из классовых противоречий
- Распространение идеологии через социальные сети (не централизованно)
- Отслеживание legitimacy и reach каждого интеллектуала
- Различные типы интеллектуалов для буржуазии, пролетариата, крестьянства

#### Модуль 3: Контр-гегемония (M3)

**Текущее состояние:**
```python
# Подчиненные классы не могут развивать альтернативные идеологии
# Они просто принимают доминирующее верование по умолчанию
```

**Будущее состояние:**
```python
# Пролетариат может развивать EQUALITY верование через:

class_consciousness_development = [
    # Этап 1: CLASS-IN-ITSELF (экономическое положение)
    # Люди находятся в положении пролетариев (не имеют средств)

    # Этап 2: LIVED EXPERIENCE (личный опыт)
    # Опыт эксплуатации, нищеты, несправедливости
    # Это кристаллизируется в memories, beliefs

    # Этап 3: NASCENT CONSCIOUSNESS (зарождающееся сознание)
    # Первые идеи о справедливости и равенстве
    # Появляются органические интеллектуалы

    # Этап 4: CLASS-FOR-ITSELF (классовое сознание)
    # Пролетариат знает свои интересы и может действовать
    # Может организоваться против доминирующего класса
]

# Условия возникновения counter-hegemony:
# - Высокая эксплуатация (видимая несправедливость)
# - Органические интеллектуалы рабочих (распространяют идеи)
# - Социальные сети рабочих (где идеи распространяются)
# - Кризис гегемонии доминирующего класса (открывает пространство)
```

**Архитектурные улучшения:**
- Пять этапов развития классового сознания (по Грамши/Лукачу)
- Появление counter-hegemonic верований через классовые противоречия
- Отслеживание "войны позиций" (идеологической борьбы)
- Возможность революционного перехода, когда consent коллапсирует

### Главные улучшения по системам

**Class System:**
- Три источника власти: экономика + политика + идеология
- Гегемонию нужно активно поддерживать через ISAs, не просто "иметь"
- Формула стабильности: 70% согласие + 30% принуждение
- Мониторинг революционных ситуаций

**Belief System:**
- Классовые фильтры **используются** при распространении (не мертвый код)
- Вероятностное распространение вместо детерминированного
- Разные верования имеют разные пути появления (не все через if-elif)
- Counter-hegemonic верования могут возникать из эксплуатации

**Organic Intellectuals:**
- Механика кристаллизации лидеров из классовых противоречий
- Распространение идеологии через социальные сети (peer-to-peer, не сверху)
- Legitimacy-based influence вместо авторитарного навязывания
- Различные интеллектуалы для разных классов

**ISAs (Institutional Ideological Apparatuses):**
- Школы: распространяют верования на молодежь
- Церковь: леги́тимируют классовый порядок
- СМИ/Культура: нормализуют доминирующую идеологию
- Семья: воспроизводят классовые позиции через социализацию

---

## EPIC 4: СОЦИАЛЬНОЕ ВОСПРОИЗВОДСТВО (SOCIAL) - Tier 3

**Epic ID:** EPIC-SOCIAL
**Приоритет:** Tier 3 (может быть параллельно с Tier 1)
**Проблем:** 36 проблем
**Продолжительность:** Недели 5-15 (параллельно, ~6-10 недель эффективно)
**Зависит от:** INT-021 (NPC унификация)

### Описание

Социальная система (семьи, демография, наследование) в текущей реализации **недостаточно интегрирована** с экономическим base. Классовое положение не наследуется реалистично, демография не интегрирована с экономическими условиями.

### Основные проблемы (36 проблем)

| ID | Категория | Проблема |
|----|-----------|----------|
| SOC-040/041 | Population | Население коллапсирует до 1-2 NPC за 20 лет |
| FAM-001 до 020 | Family System | Родство, брак, наследование неполные |
| DEM-001 до 015 | Demography | Рождаемость/смертность не связаны с ресурсами/классом |

### Модули для улучшения

**Демография:**
- Рождаемость и смертность как функции: ресурсы, класс, идеология, возраст
- Избежание коллапса через связь смертности с нищетой
- Демографическое воспроизводство классов (наследование)

**Семьи и родство:**
- Полная система родства (9 типов отношений)
- Реалистичные браки (эндогамия внутри класса чаще)
- Наследование как способ воспроизводства класса

**Социальная мобильность:**
- Редкая мобильность вверх (через образование/браки)
- Мобильность вниз (через нищету/потерю собственности)
- Класс наследуется, но не абсолютно детерминирован

---

## EPIC 5: МИР И ОКРУЖЕНИЕ (WORLD) - Tier 4

**Epic ID:** EPIC-WORLD
**Приоритет:** Tier 4
**Проблем:** 42 проблемы
**Продолжительность:** Недели 17-20 (4 недели)
**Зависит от:** Tier 1-3 (все основные системы)

### Описание

Мировая система (климат, ресурсы, пространство) недостаточно интегрирована с производством, классовой динамикой и населением. Климат не влияет на производство достаточно, ресурсы не создают движение населения, поселения не возникают эмергентно.

### Основные проблемы (42 проблемы)

| ID | Категория | Проблема |
|----|-----------|----------|
| WORLD-001 до 020 | Spatial Integration | Карта и население не интегрированы |
| WORLD-021 до 035 | Climate-Production Link | Климат не влияет на производство достаточно |
| WORLD-036 до 042 | Settlement Emergence | Поселения не возникают эмергентно |

### Модули для улучшения

**Пространственная интеграция:**
- Население распределяется по ресурсам эмергентно
- Миграция в ответ на ресурсы и климат
- Поселения возникают близко к хорошим пахотным землям

**Климат и производство:**
- Сезоны реально влияют на урожайность
- Катастрофы (засуха, наводнение) влияют на классовые отношения
- Голод может спровоцировать восстание

**Ресурсы и истощение:**
- Ресурсы истощаются при использовании
- Восстанавливаются медленнее, чем используются (в долгосроке)
- Перенос в нисходящий цикл возможен (как в Civilization)

---

## EPIC 6: AI СИСТЕМЫ (ARTIFICIAL INTELLIGENCE) - Tier 5

**Epic ID:** EPIC-AI
**Приоритет:** Tier 5 (последний)
**Проблем:** 36 проблем
**Продолжительность:** Недели 21-26 (6 недель)
**Зависит от:** INT-021 (NPC унификация)

### Описание

Система AI содержит **1,586 строк хорошо написанного кода**, который **ПОЛНОСТЬЮ НЕИСПОЛЬЗУЕТСЯ**. Это включает:
- BDI Architecture (617 строк, `src/npc/ai/bdi.py`)
- Memory System / Generative Agents (577 строк, `src/npc/memory.py`)
- Utility AI / IAUS (392 строк, `src/ai/behavior.py`)

Все эти системы написаны, но не вызываются из основного цикла симуляции.

### Критические проблемы (8 блокирующих)

| ID | Проблема | Решение |
|----|----------|--------|
| AI-001 | Отсутствие персистентности намерений | Добавить intention persistence через commitment |
| AI-005 | Отсутствие GOAP/HTN планирования | Реализовать means-end reasoning |
| AI-010 | Отсутствие компоненты планирования | Добавить Planning к Memory+Reflection |
| AI-021 | Однооси‌Utility вместо IAUS | Мультипараметрическое utility со множеством осей |
| AI-030 | Память система неиспользуемa | Wire up MemoryStream к BDI |
| AI-031 | BDI архитектура неиспользуема | Wire up BDIAgent к simulation loop |
| AI-032 | Utility AI неиспользуемо | Wire up BehaviorSystem к действиям |
| AI-035 | Три параллельных системы | Создать единый pipeline: Memory→BDI→Planning→Utility |

### Модули для улучшения

#### Модуль 1: Унифицированный когнитивный pipeline (M1)

**Архитектура:**
```
┌─────────────────────────────────────┐
│         PERCEPTION                   │
│  Наблюдения из окружения             │
└────────────────────┬────────────────┘
                     │
┌────────────────────▼────────────────┐
│    MEMORY STREAM (Generative Agents) │
│  Эпизодическая, семантическая,      │
│  процедурная память                  │
│  Восстановление через семантику     │
│  Отражение при high importance       │
└────────────────────┬────────────────┘
                     │
┌────────────────────▼────────────────┐
│    BDI DELIBERATION                  │
│  Память → Beliefs                    │
│  Нужды + Личность → Desires          │
│  Deliberation filter → Intentions    │
│  Commitment + Reconsideration        │
└────────────────────┬────────────────┘
                     │
┌────────────────────▼────────────────┐
│    PLANNING (HTN + GOAP)             │
│  Комплексные цели → HTN decomposition│
│  Простые цели → A* поиск (GOAP)      │
│  Выход: иерархический план действий  │
└────────────────────┬────────────────┘
                     │
┌────────────────────▼────────────────┐
│    UTILITY SELECTION (IAUS)          │
│  Мультиоси utility функция           │
│  Параметры: голод, холод, скука...   │
│  Болцмановское распределение         │
│  Выбирает лучшее действие            │
└────────────────────┬────────────────┘
                     │
┌────────────────────▼────────────────┐
│    EXECUTION + FEEDBACK              │
│  Действие выполняется                │
│  Результаты попадают в memory        │
│  Эмоциональный отклик                │
│  Stress accumulation/relief          │
└─────────────────────────────────────┘
```

**Улучшения:**
- Не три отдельные системы, а единый pipeline
- Memory информирует beliefs
- BDI deliberation информирует intentions
- Planning генерирует конкретные действия
- Utility выбирает между конкретными вариантами
- Execution обновляет memory и emotional state

#### Модуль 2: BDI с persistentními Intentions (M2)

**Текущее состояние:**
```python
# Нет персистентности намерений
for npc in npcs:
    action = _decide_action()  # 22-строк hardcoded логика
```

**Будущее состояние:**
```python
class BDIAgent:
    beliefs: BeliefSet
    desires: List[Goal]
    intentions: List[Intention]  # ПЕРСИСТЕНТНЫЕ, не переполняются

    def run_cycle(self):
        # 1. PERCEPTION
        beliefs.update(perceive_environment())

        # 2. DESIRE GENERATION
        needs_activation = calculate_from_personality_and_environment()
        desires = generate_goals(needs_activation)

        # 3. DELIBERATION (filter role)
        # Только новые способности или когда текущие intentions not applicable
        if not self.intentions or self.should_reconsider():
            self.intentions = deliberate(beliefs, desires)

        # 4. PLANNING
        plan = plan_intentions(self.intentions)

        # 5. EXECUTION
        action = execute_plan(plan)
        npc.perform_action(action)

        # 6. FEEDBACK
        actual_outcome = perceive_result(action)
        update_memories(action, outcome)
        emotional_response(outcome)

# Intentions персистируют через множество циклов
# Пока не достигнуты, не становятся невозможными, или не трудоспособны
```

**Улучшения:**
- Intentions persistence (не пересчитываются каждый цикл)
- Reconsideration policy (когда пересчитывать? когда доказано неправильно)
- Commitment: продолжать попытку несмотря на неудачи
- Means-end reasoning: какие действия ведут к целям

#### Модуль 3: Планирование (HTN + GOAP) (M3)

**Архитектура:**
```python
# Сложные цели: "I want to be fed" -> HTN decomposition
# 1. Find food source
#    1.1. Hunt animals / 1.2. Gather plants
# 2. Get to food source
#    2.1. Travel by foot / 2.2. Travel by cart
# 3. Consume food
#    3.1. Eat raw / 3.2. Cook first

# Простые цели: "Get to location X" -> A* через граф (GOAP)
# Current state: at A, hungry, have axe
# Goal state: at B (to hunt), have knife, not tired
# Plan: walk(A->C), craft(axe->knife), rest, hunt(location B)
```

**Улучшения:**
- HTN для комплексных, многоступенчатых целей
- GOAP для простого поиска по графу состояния
- Средства-конец рассуждение (means-end reasoning)
- Частичные планы (не все нужно планировать детально)

#### Модуль 4: Мультиоси Utility AI (M4)

**Текущее состояние:**
```python
# Однооси utility
if hunger > 0.8:
    action = "eat"
elif tiredness > 0.7:
    action = "sleep"
else:
    action = "work"  # Hardcoded default
```

**Будущее состояние:**
```python
class IFAPSystem:
    # Infinite Axis Utility AI (из The Sims)

    def calculate_utility(action: Action, npc: NPC) -> float:
        # Множество осей утилити, комбинируются мультипликативно

        u_hunger = hunger_utility(action, npc.hunger_level)  # 0-1
        u_social = social_utility(action, npc.loneliness)     # 0-1
        u_energy = energy_utility(action, npc.energy)         # 0-1
        u_bladder = bladder_utility(action, npc.bladder)      # 0-1
        u_skill = skill_utility(action, npc.skill_goals)      # 0-1

        # Мультипликативное комбинирование (один 0 = целое действие невозможно)
        utility = u_hunger * u_social * u_energy * u_bladder * u_skill

        # Кривые utility вместо скачков (smooth response)
        # Not: if hunger > 0.8 eat; else work
        # Instead: eating utility grows as hunger increases (smoothly)

        return utility

    def select_action(available_actions: List[Action], npc: NPC) -> Action:
        # Болцмановское распределение (probabilistic, not greedy)
        utilities = [self.calculate_utility(a, npc) for a in available_actions]
        probabilities = softmax(utilities / temperature)
        return np.random.choice(available_actions, p=probabilities)

# Результат: поведение плавное и реалистичное, не "жестко запрограммированное"
# Если очень голодный И очень одинокий, может выбрать социальное действие (низкая вероятность)
```

**Улучшения:**
- Мультиоси вместо однооси utility
- Параметрические кривые вместо пороговых функций (smooth response)
- Мультипликативное комбинирование (одна неудовлетворенная потребность блокирует)
- Probabilistic selection через Boltzmann distribution (не жадный выбор)

### Главные улучшения по системам

**Память:**
- Эпизодическая (события и их контекст)
- Семантическая (факты о мире)
- Процедурная (как что-то делать)
- Восстановление: recency × importance × semantic relevance
- Отражение: когда importance accumulator переполняется

**BDI:**
- Beliefs обновляются из памяти и восприятия
- Desires генерируются из нужд и личности
- Intentions формируются deliberation, персистируют через циклы
- Reconsideration: только когда нужно переоценивать

**Планирование:**
- HTN (Hierarchical Task Network) для комплексных целей
- GOAP (Goal-Oriented Action Planning) для простого поиска
- Partial planning: детальное планирование только для ближайших шагов
- Планы обновляются при изменении ситуации

**Utility Selection:**
- Мультиоси функция (голод, социальность, энергия, ...)
- Response curves (плавные, не пороговые)
- Boltzmann selection (вероятностная, не жадная)
- Personality влияет на веса осей

---

## Временная шкала реализации

### Общая стратегия: 26 недель, 6 месяцев

```
НЕДЕЛЯ 1-4:   TIER 0 - АРХИТЕКТУРНЫЕ БЛОКЕРЫ
  ├─ INT-021: Унификация NPC модели (5-8 дней)
  └─ INT-020: Активация EventBus (3-4 дня)
  └─ SOC-040/041: Выживание населения (2-3 дня)

НЕДЕЛЯ 5-10:  TIER 1 - ЭКОНОМИЧЕСКАЯ БАЗА (EPIC-ECONOMY)
  ├─ ECON-001/002: Трудовая теория стоимости + SNLT (5-6 дней)
  ├─ ECON-020/021: Первоначальное накопление (5-6 дней)
  └─ ECON-040/042: Технологическое развитие (4-5 дней)

НЕДЕЛЯ 5-15:  TIER 3 - СОЦИАЛЬНОЕ ВОСПРОИЗВОДСТВО (EPIC-SOCIAL, параллельно)
  ├─ SOC-040/041: Стабильная демография (1-2 недели)
  ├─ FAM-001/020: Семьи и наследование (2-3 недели)
  └─ DEM-001/015: Демографические связи (2-3 недели)

НЕДЕЛЯ 11-16: TIER 2 - НАДСТРОЙКА (EPIC-SUPERSTRUCTURE)
  ├─ SOC-001/003: Гегемония и интеллектуалы (3-4 дня)
  ├─ CULT-007/009: Фильтры верований и ISAs (4-5 дней)
  └─ SOC-009/CULT-013: Контр-гегемония (3-4 дня)

НЕДЕЛЯ 17-20: TIER 4 - МИР И ОКРУЖЕНИЕ (EPIC-WORLD)
  ├─ WORLD-001/020: Пространственная интеграция (2-3 недели)
  ├─ WORLD-021/035: Климат-производство связь (1 неделя)
  └─ WORLD-036/042: Эмергентные поселения (1 неделя)

НЕДЕЛЯ 21-26: TIER 5 - AI СИСТЕМЫ (EPIC-AI)
  ├─ AI-030/031/032: Подключение AI систем (3-4 дня)
  ├─ AI-001/005: Persistence и GOAP (5-6 дней)
  ├─ AI-021: IAUS Utility (3-4 дня)
  └─ AI-010/018: Полная Memory-Reflection (4-5 дней)

НЕДЕЛЯ 26: ПОЛИРОВКА И QA
  └─ Верификация всех систем, оптимизация производительности
```

### Критический путь для MVP (Minimum Viable Marxist Simulation): 10-12 недель

Чтобы продемонстрировать **базис → надстройка** динамику:

```
НЕДЕЛЯ 1-4:  TIER 0 - БЛОКЕРЫ
  INT-021, INT-020, SOC-040/041

НЕДЕЛЯ 5-6:  TIER 1A - ТРУДОВАЯ ТЕОРИЯ СТОИМОСТИ
  ECON-001, ECON-002, INT-001

НЕДЕЛЯ 7-8:  TIER 1B - СОБСТВЕННОСТЬ И КЛАССЫ
  ECON-020/021, INT-002, INT-003

НЕДЕЛЯ 9-10: TIER 2A - ГЕГЕМОНИЯ И ВЕРОВАНИЯ
  SOC-001, CULT-007, INT-018

НЕДЕЛЯ 11-12: ВЕРИФИКАЦИЯ И ДЕМОНСТРАЦИЯ
  MVP COMPLETE: Видно как Economic Base (собственность, стоимость) -> Class Formation -> Ideology Propagation
```

---

## Метрики успеха: Как узнать, что система работает

### Phase 1 Success (Неделя 4)
- [x] Население поддерживает 10+ NPCs в течение 100 лет симуляции (вместо коллапса до 1-2)
- [x] Нет коллапса от голода
- [x] AI системы получают обновления состояния NPC

### Phase 2 Success (Неделя 10)
- [x] Производство варьируется в зависимости от рабочего времени (не просто const)
- [x] Неравенство собственности может возникать эмергентно (Gini > 0.3)
- [x] Пролетариат формируется через отчуждение (dispossession)
- [x] Технология требует материального surplus (не просто случайно)

### Phase 3 Success (Неделя 16)
- [x] Классы образуются на основе отношения к средствам производства
- [x] Гегемония стабильности требует согласия, не только экономической власти
- [x] Рабочие могут развивать egalitarian counter-ideology
- [x] Классовое сознание распространяется через социальные сети

### Phase 4 Success (Неделя 20)
- [x] Климат влияет на выход производства
- [x] Ресурсы истощаются и восстанавливаются
- [x] Поселения возникают эмергентно близко к ресурсам
- [x] Миграция в ответ на ресурсы и климат

### Phase 5 Success (Неделя 26)
- [x] NPCs поддерживают связное ежедневное расписание через planning
- [x] Память влияет на образование belief
- [x] Личность влияет на выбор действия
- [x] Intentions персистируют через множество симуляционных циклов

---

## Интеграция с существующей документацией

Для подробного понимания каждого EPIC, см.:

- **EPIC-INTEGRATION**: `.auto-claude/specs/002-/EPIC_INTEGRATION.md` (759 строк)
- **EPIC-ECONOMY**: `.auto-claude/specs/002-/EPIC_ECONOMY.md` (619 строк)
- **EPIC-SUPERSTRUCTURE**: `.auto-claude/specs/002-/EPIC_SUPERSTRUCTURE.md` (707 строк)
- **EPIC-AI**: `.auto-claude/specs/002-/EPIC_AI.md` (644 строк)
- **MASTER**: `.auto-claude/specs/002-/EPICS_MASTER.md` (порядка 400 строк)

Каждый документ содержит:
- Список всех проблем (ID, description, severity, effort)
- Теоретические основания (Marx, Gramsci, Bratman, Park et al., IAUS)
- Подробные Milestones с tasks, acceptance criteria, effort estimates
- Примеры кода (как было → как будет)
- Risk assessment и quick wins

---

## Заключение

**Текущее состояние:** Система содержит хороший код, но архитектурно сломана. 40% кода не вызывается.

**Будущее состояние:** Функциональная марксистская симуляция, демонстрирующая:
- Как экономический base определяет надстройку
- Как классы возникают из собственности
- Как идеология распространяется для легитимации
- Как революции возникают из противоречий

**Временная инвестиция:** 26 недель (~6 месяцев)

**Стратегия:** Начать с архитектурных блокеров (4 недели), затем экономическая база (6 недель), затем надстройка (6 недель), параллельно социальная система. Сначала AI системы.

**MVP (10-12 недель):** Базис → Надстройка цепочка работает на простом примере: собственность → класс → верование.

---

## Ссылки на документацию Task 002

**Основные документы:**
- Spec 002: `.auto-claude/specs/002-/spec.md` - полное исследование
- EPICS_MASTER.md - обзор всех EPICs и зависимостей
- EPIC_INTEGRATION.md - 19 архитектурных проблем
- EPIC_ECONOMY.md - 39 экономических проблем
- EPIC_SUPERSTRUCTURE.md - 27 идеологических проблем
- EPIC_AI.md - 36 AI проблем

**Специализированные исследования:**
- FINDINGS.md - все 197 проблем с IDками
- PRIORITY_MATRIX.md - матрица приоритетов по severity
- CATEGORY_SUMMARY.md - группировка по категориям
- RESEARCH_MARXIST.md - теоретический контекст
- RESEARCH_AI.md - AI/BDI/GOAP background
- RESEARCH_ABM.md - Agent-based modeling best practices

---

*Документ создан как часть Task 012 (Полная документация на русском)*
*Основано на Task 002 (World Simulation Realism Investigation)*
*Версия: 1.0 | Дата: 2026-02-02*
