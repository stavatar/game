# Базис и Надстройка

**Симулятор развития общества на основе марксистской теории**

Наблюдайте, как из примитивной общины эмерджентно возникают:
- Частная собственность
- Социальные классы
- Классовые конфликты
- Идеология и верования

Каждый NPC уникален и принимает решения самостоятельно на основе BDI-архитектуры (Beliefs-Desires-Intentions).

## Особенности

### Марксистская Модель
- **Базис определяет надстройку** — экономические отношения порождают культуру
- **Эмерджентные классы** — классы ВОЗНИКАЮТ из отношений собственности, не задаются жёстко
- **Классовое сознание по Грамши** — organic intellectuals, фазы развития сознания
- **Классовые конфликты** — забастовки, бунты, восстания с различными исходами

### Уникальные NPC (Generative Agents)
Каждый житель имеет:
- **Генетику** — наследуемые черты от родителей с мутациями
- **Личность** — 12+ черт характера, влияющих на решения
- **Память** — события, рефлексии, важные воспоминания
- **Потребности** — голод, сон, безопасность, социализация
- **Отношения** — друзья, враги, семья, романтические связи
- **Верования** — формируются под влиянием экономики и кризисов

### Живой Мир
- **Время** — часы, дни, месяцы, годы, сезоны
- **Климат** — засухи, наводнения, эпидемии влияют на ресурсы
- **Технологии** — 40+ технологий от каменных орудий до металлургии
- **Производство** — 20+ методов производства с requirements

## Установка

```bash
# Клонирование
git clone https://github.com/stavatar/game.git
cd game

# Для графического режима
pip install pygame-ce

# Запуск тестов
pip install pytest
pytest tests/
```

## Запуск

### Текстовый Режим (CLI)
```bash
python main.py
```

**Команды:**
| Клавиша | Действие |
|---------|----------|
| `1` | Пропустить 1 час |
| `2` | Пропустить 1 день |
| `3` | Пропустить 1 месяц |
| `4` | Пропустить 1 год |
| `5` | Список жителей |
| `6` | Подробная статистика |
| `s` | Сохранить игру |
| `l` | Загрузить игру |
| `f` | Быстрое сохранение |
| `a` | Авто-режим |
| `q` | Выход |

### Графический Режим (pygame)
```bash
python main_gui.py
```

**Управление:**
| Клавиша | Действие |
|---------|----------|
| `WASD` / Стрелки | Перемещение камеры |
| Колесо мыши | Масштабирование |
| ЛКМ на NPC | Информация о жителе |
| ПКМ | Снять выделение |
| `Пробел` | Пауза |
| `1-4` | Скорость (x1, x2, x5, x10) |
| `G` | Показать/скрыть сетку |
| `F5` | Быстрое сохранение |
| `F9` | Быстрая загрузка |
| `F6` | Автосохранение |
| `ESC` | Выход |

## Примеры Работы

### Главное Меню (CLI)
```
============================================================
БАЗИС И НАДСТРОЙКА
Симулятор развития общества
============================================================

  1 - Новая игра
  2 - Загрузить сохранение
  3 - Выход

>
```

### Игровой Процесс
```
=== ГОД 47 | День 156 | Население: 34 ===
Эра: Неолит | Поколений: 2

КАРТА:
  ~~##..##~~
  ~###@@###~
  .##@@@##..
  ...@@@....

Последние события:
  • Иван открыл технологию: Земледелие
  • Мария родила сына
  • Конфликт между LANDOWNER и LABORER обострился
  • Пётр стал органическим интеллектуалом

Команды:
  1 - Час          2 - День       3 - Месяц
  4 - Год          5 - Жители     6 - Статистика
  s - Сохранить    l - Загрузить  f - Быстрое сохр.
  a - Авто-режим   q - Выход

>
```

### Статистика
```
=== СТАТИСТИКА ===

Экономика (БАЗИС):
  Эра: Бронзовый Век
  Технологий открыто: 23
  Частная собственность: да
  Неравенство (Джини): 0.42

Общество:
  Семей: 8
  Классы: {'LANDOWNER': 3, 'LABORER': 12, 'CRAFTSMAN': 5}
  Напряжённость: 0.67
  Активные конфликты: 1

Культура (НАДСТРОЙКА):
  Верований: 4
    - Культ предков: 28 чел.
    - Иерархия естественна: 15 чел.
    - Собственность священна: 8 чел.

Демография:
  Рождений в этом году: 5
  Смертей в этом году: 2
  Ожидаемая продолжительность жизни: 42
```

### Классовый Конфликт
```
=== КЛАССОВЫЙ КОНФЛИКТ ===
Тип: Забастовка
Стадия: Активный конфликт
Интенсивность: 0.65

Участники:
  LABORER: 8 человек
  LANDOWNER: 2 человека

Лидеры: Пётр, Анна
Требования:
  - Справедливое распределение урожая
  - Доступ к орудиям труда

Классовое сознание LABORER: 0.72 (Политическое)
```

### Графический Интерфейс

GUI отображает:
- **Карту мира** с тайлами (лес, вода, равнина, горы)
- **NPC как спрайты** с цветом класса
- **Индикаторы сознания** (размер кольца вокруг NPC)
- **Маркеры лидеров** (корона) и интеллектуалов (звезда)
- **Панели**: статус, информация о NPC, лог событий, статистика
- **Зоны конфликтов** (красное свечение)

## Структура Проекта

```
src/
├── core/                    # Ядро симуляции
│   ├── simulation.py        # Главный цикл
│   ├── config.py            # Конфигурация
│   └── events.py            # Pub/Sub события
│
├── world/                   # Мир и окружение
│   ├── map.py               # Карта мира
│   ├── location.py          # Локации
│   ├── time_system.py       # Время и сезоны
│   └── climate.py           # Климат и катаклизмы
│
├── economy/                 # Экономический базис
│   ├── resources.py         # Ресурсы и инвентарь
│   ├── production.py        # Методы производства
│   ├── technology.py        # Технологическое древо
│   └── property.py          # Система собственности
│
├── society/                 # Социальная структура
│   ├── family.py            # Семьи
│   ├── demography.py        # Рождения и смерти
│   └── classes.py           # Классы и конфликты
│
├── culture/                 # Культурная надстройка
│   ├── beliefs.py           # Верования (эмерджентные)
│   ├── traditions.py        # Традиции
│   └── norms.py             # Социальные нормы
│
├── npc/                     # Уникальные NPC
│   ├── character.py         # Характеристики
│   ├── personality.py       # Личность
│   ├── needs.py             # Потребности
│   ├── relationships.py     # Отношения
│   ├── genetics.py          # Генетика
│   ├── memory.py            # Память (Generative Agents)
│   └── ai/
│       └── bdi.py           # BDI-архитектура
│
├── ai/                      # Поведенческая система
│   └── behavior.py          # Принятие решений
│
├── ui/                      # Графический интерфейс
│   ├── window.py            # Главное окно
│   ├── camera.py            # Камера с zoom/scroll
│   ├── renderer.py          # Рендеринг карты
│   ├── sprites.py           # Спрайты NPC
│   ├── panels.py            # UI панели
│   └── colors.py            # Цветовая палитра
│
└── persistence/             # Сохранение/загрузка
    ├── schema.py            # Схема данных
    ├── serializers.py       # Сериализаторы
    └── save_manager.py      # Менеджер сохранений

main.py                      # Точка входа (CLI)
main_gui.py                  # Точка входа (GUI)
```

## Архитектура

### Порядок Обновления (Марксистский)
```
Time → Economy (Базис) → Society → Culture (Надстройка) → NPC
```

### BDI-Архитектура NPC
```
Perceive → Beliefs → Desires → Intentions → Actions
    ↑                                           ↓
    └───────────── Memory ←─────────────────────┘
```

### Система Событий (Pub/Sub)
```python
# Подписка
event_bus.subscribe(EventType.NPC_BORN, handler)

# Публикация
event_bus.publish(EventType.NPC_BORN, {"npc_id": npc.id})
```

### Эмерджентные Классы
```python
def determine_class(npc, ownership):
    if not ownership.private_property_emerged:
        return ClassType.COMMUNAL_MEMBER

    if ownership.owns_land(npc.id):
        return ClassType.LANDOWNER
    elif ownership.owns_tools(npc.id):
        return ClassType.CRAFTSMAN
    else:
        return ClassType.LABORER
```

## Формат Сохранений

Сохранения хранятся в `saves/` как `.sav.gz` файлы:

```json
{
  "metadata": {
    "version": "1.0.0",
    "save_name": "quicksave",
    "year": 156,
    "population": 34,
    "era": "Bronze Age",
    "created_at": "2026-02-01T15:30:00",
    "checksum": "abc123..."
  },
  "config": { ... },
  "time": { "year": 156, "day": 234, "hour": 14 },
  "map": { ... },
  "npcs": [ ... ],
  "economy": { ... },
  "society": { ... },
  "culture": { ... }
}
```

## Тестирование

```bash
# Все тесты
pytest tests/ -v

# Только классы
pytest tests/test_classes.py -v

# С покрытием
pytest tests/ --cov=src
```

**Текущее покрытие:** 52 теста для классовой системы

## Методология

Проект разработан по методологии **BMAD-METHOD**:
- Epics и User Stories в формате Gherkin
- Evil Audit с 10+ агентами после каждого шага
- Дебаты между агентами для консенсуса

**Статус Backlog:** 28/28 stories (100% complete)

| Story | Evil Audit Score |
|-------|------------------|
| US-4.3 Классовые Конфликты | 8.75/10 |
| US-8.3 Графический Интерфейс | 8.42/10 |
| US-9.1 Сохранение/Загрузка | 8.33/10 |

## Теоретическая Основа

### Марксизм
- **Исторический материализм** — способ производства определяет общественные отношения
- **Базис и надстройка** — экономика формирует культуру, право, идеологию
- **Классовая борьба** — двигатель истории

### Антонио Грамши
- **Гегемония** — культурное господство правящего класса
- **Органические интеллектуалы** — лидеры, формирующие сознание класса
- **Фазы сознания** — экономическое → корпоративное → политическое → гегемонное

### Generative Agents (Stanford 2023)
- **Память** — хранение и retrieval воспоминаний
- **Рефлексия** — формирование обобщений из опыта
- **Планирование** — долгосрочные цели и намерения

## Лицензия

MIT License

## Авторы

- Разработка: Claude Code (Anthropic)
- Методология: BMAD-METHOD
- Теория: К. Маркс, А. Грамши

---

*"История всех до сих пор существовавших обществ была историей борьбы классов."*
— Карл Маркс, Манифест Коммунистической Партии (1848)
